## 2. 奇门遁甲排盘算法设计

奇门遁甲排盘是一个复杂的过程，涉及到天文、历法、易学等多个领域的知识。为了在网页端实现排盘功能，我们需要将这些复杂的规则转化为可执行的算法。

### 2.1 排盘核心流程

奇门遁甲排盘的核心流程可以概括为以下几个主要步骤：

1.  **确定四柱**：根据用户输入的年、月、日、时，推算出对应的农历干支纪年、纪月、纪日、纪时。这是排盘的基础。
    *   **年柱**：根据公历年份推算。
    *   **月柱**：根据节气推算，而非农历月份。
    *   **日柱**：根据公历日期推算。
    *   **时柱**：根据公历日期和时辰推算。

2.  **确定局数（阴阳遁）**：根据查询时间所在的节气（上元、中元、下元）和日干支，确定奇门遁甲的局数。局数分为阳遁一局到九局，以及阴遁一局到九局。
    *   **阳遁**：冬至后到夏至前，阳气渐长，使用阳遁局。
    *   **阴遁**：夏至后到冬至前，阴气渐长，使用阴遁局。
    *   **超神接气**：需要考虑节气交接时的特殊情况，即在节气前或节气后一定时间内，可能需要使用上一个或下一个节气的局数。

3.  **排地盘三奇六仪**：地盘是固定不变的，由洛书九宫和八卦组成。将甲子戊、甲戌己、甲申庚、甲午辛、甲辰壬、甲寅癸这六仪以及乙、丙、丁三奇按照固定的顺序排布到九宫中。
    *   **地盘宫位**：坎一宫、坤二宫、震三宫、巽四宫、中五宫、乾六宫、兑七宫、艮八宫、离九宫。
    *   **六仪排布**：戊、己、庚、辛、壬、癸。
    *   **三奇排布**：乙、丙、丁。

4.  **确定值符和值使**：
    *   **值符**：时干所在旬的旬首（如甲子旬的甲子），其落宫即为值符所在宫位。
    *   **值使**：时干所在旬的旬首所对应的八门（如甲子旬的戊，戊对应的开门），其落宫即为值使所在宫位。

5.  **排天盘九星**：将九星（天蓬、天芮、天冲、天辅、天禽、天心、天柱、天任、天英）按照值符的落宫，根据阴阳遁的顺逆行规则，依次排布到九宫中。
    *   **阳遁**：顺时针方向排布。
    *   **阴遁**：逆时针方向排布。
    *   **天禽星**：通常与天芮星同宫。

6.  **排人盘八门**：将八门（休、生、伤、杜、景、死、惊、开）按照值使的落宫，根据阴阳遁的顺逆行规则，依次排布到九宫中。
    *   **阳遁**：顺时针方向排布。
    *   **阴遁**：逆时针方向排布。

7.  **排神盘八神**：将八神（值符、腾蛇、太阴、六合、白虎、玄武、九地、九天）按照值符的落宫，根据阴阳遁的顺逆行规则，依次排布到九宫中。
    *   **阳遁**：顺时针方向排布。
    *   **阴遁**：逆时针方向排布。

### 2.2 阴阳遁算法差异

阴阳遁的主要差异体现在九星、八门、八神的排布方向上：

*   **阳遁**：所有元素（九星、八门、八神）在九宫中均按**顺时针**方向依次排布。
*   **阴遁**：所有元素（九星、八门、八神）在九宫中均按**逆时针**方向依次排布。

### 2.3 数据结构与算法实现方案

为了实现上述排盘算法，我们需要定义以下数据结构和辅助函数：

#### 2.3.1 数据结构

1.  **宫位（Palace）对象**：
    ```javascript
    class Palace {
        constructor(name, number) {
            this.name = name; // 宫位名称，如“坎一宫”
            this.number = number; // 宫位数字，1-9
            this.celestialStem = ''; // 天盘天干
            this.terrestrialBranch = ''; // 地盘地支
            this.star = ''; // 九星
            this.door = ''; // 八门
            this.deity = ''; // 八神
            this.hiddenStem = ''; // 旬空等隐藏信息
        }
    }
    ```

2.  **奇门盘（QimenChart）对象**：
    ```javascript
    class QimenChart {
        constructor() {
            this.palaces = {}; // 存储9个宫位对象，键为宫位数字
            this.overallInterpretation = ''; // 整体解读
            this.dateInfo = {}; // 日期信息，包括四柱、节气、局数等
        }
    }
    ```

3.  **常量定义**：
    *   天干：`['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸']`
    *   地支：`['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥']`
    *   八卦与宫位对应关系：`{1: '坎', 2: '坤', 3: '震', 4: '巽', 5: '中', 6: '乾', 7: '兑', 8: '艮', 9: '离'}`
    *   九星、八门、八神顺序数组。
    *   节气与局数对应表。

#### 2.3.2 辅助函数

1.  **日期时间处理函数**：
    *   `getLunarDate(year, month, day, hour)`：将公历日期转换为农历日期和干支。
    *   `getSolarTerm(date)`：根据日期获取当前节气。
    *   `getQimenJu(date, dunType)`：根据节气和阴阳遁类型确定局数。

2.  **排盘计算函数**：
    *   `initEarthPlate()`：初始化地盘三奇六仪。
    *   `findZhiFuZhiShi(timeGanZhi, juNum)`：确定值符和值使。
    *   `arrangeStars(zhiFuPalace, juNum, dunType)`：排布九星。
    *   `arrangeDoors(zhiShiPalace, juNum, dunType)`：排布八门。
    *   `arrangeDeities(zhiFuPalace, juNum, dunType)`：排布八神。
    *   `calculateHiddenStems()`：计算旬空等隐藏信息。

#### 2.3.3 算法实现思路

1.  **模块化**：将排盘算法拆分为独立的模块，每个模块负责一个具体的计算步骤，提高代码的可维护性和可读性。
2.  **数据驱动**：将奇门遁甲的各种常量（如天干地支、九星八门顺序、节气局数表等）存储为数据，通过查表的方式进行计算，而不是硬编码逻辑。
3.  **面向对象**：使用JavaScript的类（Class）来定义宫位和奇门盘对象，更好地组织数据和方法。
4.  **逐步实现**：从最基础的四柱计算开始，逐步实现局数确定、地盘排布、天盘、人盘、神盘的排布，每一步都进行充分测试。
5.  **前端展示与后端计算分离**：虽然是静态网页，但复杂的排盘计算逻辑可以独立于UI，方便后续扩展或迁移到后端。

### 2.4 关键挑战与解决方案

1.  **农历与干支转换**：需要一个准确的农历/公历转换库，并能推算出干支纪年、纪月、纪日、纪时。可以考虑使用现有的JavaScript库，如`solarLunar`或自行实现。
2.  **节气计算**：节气时间是精确到分钟的，需要准确计算出每个节气的交节时间，以便确定局数和超神接气。
3.  **排盘规则的复杂性**：奇门遁甲的排盘规则非常精细，例如活盘、死盘、马星、空亡等，需要仔细研究并准确实现。
4.  **性能优化**：虽然是静态网页，但如果计算量过大，可能会影响用户体验。需要优化算法，避免不必要的重复计算。

通过以上设计，我们可以在前端实现一个功能较为完善的奇门遁甲排盘算法。

